<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>{{title}}</title>
    <!-- Favicon-->
    <link rel="icon" href="/images/icone.png"> 
    <!-- project css file  -->
    <link rel="stylesheet" href="/css/estilo.css">
    <link rel="stylesheet" href="/css/emojionearea.css">

    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  </head>
  
  {{#if_cond login '!=' ''}}
  <body onload="getMessages()">
  {{else}}
  <body style="background-color: #075E54;">
  {{/if_cond}}

    {{#if_cond container '==' false}}
    <div>
    {{else}}
    <div class="container">
    {{/if_cond}}
      

      {{{body}}}


    </div>
  <!-- Jquery Core Js -->
  <script src="/js/libscripts.bundle.js"></script>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js" integrity="sha384-7EyYLQZgWBi67fBtVxw60/OWl1kjsfrPFcaU0pp0nAh+i8FD068QogUvg85Ewy1k" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
        <script src="/js/emojionearea.js"></script>
        <script>
            $('#textarea').emojioneArea({
                pickerPosition: "top"
            });

            

            var query = location.search.slice(1);
            var partes = query.split('&');
            var data = {};
            partes.forEach(function (parte) {
                var chaveValor = parte.split('=');
                var chave = chaveValor[0];
                var valor = chaveValor[1];
                data[chave] = valor;
            });

            
            //headerClient chatBody chatFooter
            if (typeof data.wa_id !== 'undefined') {
                document.getElementById("headerClient").style.display = "block";
                document.getElementById("headerClientEmpty").style.display = "none";
                document.getElementById("chatBody").style.display = "block";
                document.getElementById("chatBodyEmpty").style.display = "none";
                document.getElementById("chatFooter").style.display = "block";
                document.getElementById("chatFooterEmpty").style.display = "none";

                

                //RENDER MESSAGES IN CHAT
                const clientNumber = data.wa_id
                fetch('https://localhost:3000/wpp/message-chat-client', {
                  method: 'POST',
                  headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                  },  
                  body: JSON.stringify(data),
                }).then(res => res.json())
                  .then(data => {
                    
                    
                    //render msg chat
                    renderMessagesInChat(data, clientNumber);
                  })
                  .catch(err => {
                  console.log(err)
                })

                
            }else{
              console.log('x2');
                document.getElementById("headerClient").style.display = "none";
                document.getElementById("headerClientEmpty").style.display = "block";
                document.getElementById("chatBody").style.display = "none";   
                document.getElementById("chatBodyEmpty").style.display = "block";
                document.getElementById("chatFooter").style.display = "none";
                document.getElementById("chatFooterEmpty").style.display = "block";
              
  
            }


            function renderMessagesInChat(arr,clientNumber){

              //take name
              fetch('https://localhost:3000/wpp/client-data',{
                method: 'POST',
                  headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                  },  
                  body: JSON.stringify({clientNumber: clientNumber}),
              }).then((res) => res.json())
                .then((data) => {

                  const name = data[0].name

                 

                  //render info in chat

                 document.getElementById("chat-client-name").innerText = name;
                 document.getElementById("chat-client-photo").src = `https://ui-avatars.com/api/?name=${name}&background=random&color=ff0000&bold=true`;

                 const chatBody = document.getElementById('chatBody');

                
                 for(item of arr){
                  var timeMsg = item.created_at;

                  if(timeMsg.indexOf('Z') != -1){
                              const date = new Date(timeMsg.replace('Z',''));
                              
                              const hour = String(date.getHours()).padStart(2,'0');
                              const minute = String(date.getMinutes()).padStart(2,'0');
                              
                              timeMsg = hour + ':' + minute;
                          }
                                
                  if(arr["to_wa"] == undefined){
                    chatBody.insertAdjacentHTML("beforeend",`
                    <li class="mb-3 d-flex flex-row align-items-end">
                                    <div class="max-width-70">
                                        <div class="user-info mb-1">
                                            <span class="text-muted small">
                                            ${timeMsg},<br>${name}:</span>
                                        </div>
                                        <div class="card border-0 p-3">
                                            <div class="message"> ${item["body"]}</div>
                                        </div>
                                    </div>
                                </li>`)
                  }

                 }

                  /*
                  <!-- Chat: right -->
                                <li class="mb-3 d-flex flex-row-reverse align-items-end">
                                    <div class="max-width-70 text-right">
                                        <div class="user-info mb-1">
                                            <span class="text-muted small">13:00, Hoje</span>
                                        </div>
                                        <div class="card border-0 p-3 bg-primary text-light">
                                            <div class="message">Bom dia, em que podemos ajudar?</div>
                                        </div>
                                    </div>
                                </li>
                  <!-- Chat: left -->
                                <li class="mb-3 d-flex flex-row align-items-end">
                                    <div class="max-width-70">
                                        <div class="user-info mb-1">
                                            <span class="text-muted small">
                                            12:59, Hoje<br>Kevin:</span>
                                        </div>
                                        <div class="card border-0 p-3">
                                            <div class="message"> Estou precisando de ajuda com minha fatura.</div>
                                        </div>
                                    </div>
                                </li>
                  */
              }).catch((res) => console.log(res));

                            
            }
        
        </script>
        <script>
          function msgErroLogin(){
            Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Email ou senha incorreto!'
            })
          }
          
          if({{message}}){
            msgErroLogin();
            
          }          
        </script>
        <!-- Jquery Core Js -->
        <script src="/bundles/libscripts.bundle.js"></script>
        <!-- Plugin Js-->
        <script src="/bundles/apexcharts.bundle.js"></script>
        <!-- Jquery Page Js -->
        <!-- tawk chat -->
        <script src="/js/template.js"></script>
        <script src="/js/page/hr.js"></script>

  </body>
</html>
