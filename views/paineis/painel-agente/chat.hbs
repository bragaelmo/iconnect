<div id="mytask-layout" class="theme-indigo">
        {{#if_cond sidebars '==' 'aget'}}
        {{> sidebarAgente}}
        {{else}}
        {{> sidebarSupervisor}}
        {{/if_cond}}
    <!-- main body area -->
    <div class="main px-lg-4 px-md-4">
        <!-- Body: Header -->
        {{> header}}
        <!-- Body: Body -->
        <div class="body d-flex">
            <div class="container-xxl p-0">
                <div class="row g-0">
                    <div class="col-12 d-flex">
                        <!-- Card: -->
                        <div class="card card-chat border-right border-top-0 border-bottom-0  w380" style="transform: translate(0px, -50px);">
                            <div class="px-4 py-3 py-md-4">
                                <div class="input-group mb-3">
                                    <input id="searchbar" name="search" type="text" onkeyup="search_conversation()" class="form-control mb-1" placeholder="Pesquisar...">
                                </div>
                                <div class="nav nav-pills justify-content-between text-center" role="tablist">
                                    <a class="flex-fill rounded border-0 nav-link active" id="em-espera-style" data-bs-toggle="tab" href="#em-espera" role="tab" aria-selected="false"><i class="icofont-ui-clock fs-5"></i> Em Espera</a>
                                    <a class="flex-fill rounded border-0 nav-link" id="em-atendimento-style" data-bs-toggle="tab" href="#em-atendimento" role="tab" aria-selected="true"><i class="icofont-ui-chat fs-5"></i> Em Atendimento</a>
                                </div>
                            </div>
                            <div class="tab-content border-top">
                                <div class="tab-pane fade show active" id="em-espera" role="tabpanel">
                                    <ul id="contact_area" class="list-unstyled list-group list-group-custom list-group-flush mb-0">
                                        {{!-- <li class="list-group-item px-md-4 py-3 py-md-4">
                                            <a href="?wa_id=8" class="d-flex">
                                                <img class="avatar lg rounded-circle img-thumbnail" style="border: 1px solid silver; text-align: center;" src="https://ui-avatars.com/api/?name=kevin&background=random&color=ff0000&bold=true">
                                                <div class="flex-fill ms-3 text-truncate">
                                                    <h6 class="d-flex justify-content-between mb-0"><span>Kevin</span> <small class="msg-time">10:45 AM</small></h6>
                                                    <span class="text-muted"> <i class="icofont-swoosh-right   fs-5"></i> </span> Rex telecom</span>
                                                </div>
                                            </a>
                                        </li> --}}

                                    </ul>
                                </div>
                                <div class="tab-pane fade" id="em-atendimento" role="tabpanel">
                                    <ul id="contact_area_atendimento" class="list-unstyled list-group list-group-custom list-group-flush mb-0">
                                        <!-- Carrega cv novas-->
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <!-- Card: -->
                        <div class="card card-chat-body border-0  w-100 px-4 px-md-5 py-3 py-md-4" style="height: 79vh" >
                            <!-- Chat: Header -->
                            <div class="chat-header d-flex justify-content-between align-items-center border-bottom pb-3">
                                <div class="row">
                                    <div class="col-10">
                                        <!-- Body: Header -->
                                        <div class="header">
                                            <nav class="navbar py-4">
                                                <div class="container-xxl">
                                                    <!-- menu toggler -->
                                                    <button class="navbar-toggler p-0 border-0 menu-toggle order-3 ms-1" type="button" data-bs-toggle="collapse" data-bs-target="#mainHeader">
                                                    <span class="fa fa-bars"></span>
                                                    </button>
                                                    <!-- main menu Search-->
                                                    <div id="headerClient" style="display: none;" class="order-0 col-lg-4 col-md-4 col-sm-12 col-12 mb-3 mb-md-0 ">
                                                        <div class="order-0 col-lg-4 col-md-4 col-sm-12 col-12 mb-3 mb-md-0 ">
                                                            <div class="input-group flex-nowrap input-group-lg">
                                                                <a href="./" title="Home"><i class="icofont-arrow-left fs-4"></i></a>
                                                                <img id="chat-client-photo" class="ms-3 avatar rounded-circle" style="border: 1px solid silver; text-align: center;" src="https://ui-avatars.com/api/?name=kevin&background=random&color=ff0000&bold=true" width="35">
                                                                <div style="transform: translateY(4px);">
                                                                    <div class="btn-group dropend">
                                                                        <a style="border: none; font-size: 18px; cursor: pointer;"class="dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                                                                            <span id="chat-client-name">Carregando...</span>
                                                                            <span id="chat-client-phone" style="display:none;"></span>
                                                                            <span id="chat-client-type" style="display:none;"></span>
                                                                            <span id="chat-client-atendimento-id" style="display:none;"></span>
                                                                            <span id="chat-received-zenvia-number" style="display:none;"></span>
                                                                        </a>
                                                                        <ul class="dropdown-menu border-0 shadow py-3 px-2">
                                                                            <li>
                                                                                <button type="button" class="dropdown-item py-2 rounded" onclick="preparaEncerrarAtendimento()" data-bs-toggle="modal" data-bs-target="#modalEncerrarAtendimento">
                                                                                <i class="icofont-close"></i> Encerrar
                                                                                </button>
                                                                            </li>
                                                                        </ul>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div id="headerClientEmpty" class="order-0 col-lg-4 col-md-4 col-sm-12 col-12 mb-3 mb-md-0 ">
                                                        <div class="order-0 col-lg-12 col-md-12 col-sm-12 col-12 mb-3 mb-md-0 ">
                                                            <div class="input-group flex-nowrap input-group-lg">
                                                                <div style="transform: translateY(-6px);">
                                                                    <div class="btn-group">
                                                                        <a style="border: none; font-size: 25px;"class="dropdown-toggle">
                                                                        <span>Selecione uma Conversa</span>
                                                                        </a>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </nav>
                                        </div>
                                        <!-- Body: Body -->
                                    </div>
                                    <div class="col-2">
                                        <!-- Body: Header -->
                                        <div class="header">
                                            <nav class="navbar py-4">
                                                <div class="container-xxl">
                                                    <!-- main menu Search-->
                                                    <div id="buttonMoverAtendimentoDiv" style="display:none;" class="order-0 col-lg-12 col-md-12 col-sm-12 col-12 mb-3 mb-md-0 ">
                                                        <div class="order-0 col-lg-12 col-md-12 col-sm-12 col-12 mb-3 mb-md-0 ">
                                                            <div class="input-group flex-wrap input-group-lg">
                                                                <div style="transform: translateY(-6px);">
                                                                    <button class="btn btn-primary" id="buttonAtender" style="display: none;">
                                                                        <span style="font-size: 15px;">Atender</span>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </nav>
                                        </div>
                                        <!-- Body: Body -->
                                    </div>
                                    <div class="col-12">
                                        <div class="d-flex align-items-center">
                                            {{!-- MODAL CLOSE MESSAGE --}}
                                            <div class="modal fade" id="modalCloseMessage" tabindex="-1" aria-labelledby="modalCloseMessage" style="display: none;" aria-hidden="true">
                                                <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                                                    <div class="modal-content">
                                                        <div class="modal-header" style="background-color: #075E54; color: white; font-weight: bold;">
                                                            <h5 class="modal-title" id="modalCloseMessage"> <i class="icofont-ui-chat fs-5"></i> Deseja mover o atendimento?</h5>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                        </div>
                                                        <div class="modal-body" id="bodyModalCloseMessage">
                                                            <span id="spanInBodyModalCloseMessage"></span><b><span style="color: #8B0000"><i class="icofont-ui-chat fs-5"></i> Em Atendimento</span></b> ?
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                                                            <button type="button" id="buttonMover" class="btn btn-primary">Mover</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- Modal Tranferir-->

                                            <!-- Modal Convidar Agente-->
                                            <div class="modal fade" id="modalEncerrarAtendimento" tabindex="-1" aria-labelledby="modalEncerrarAtendimento" style="display: none;" aria-hidden="true">
                                                <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                                                    <div class="modal-content">
                                                        <div class="modal-header" style="background-color: #075E54; color: white; font-weight: bold;">
                                                            <h5 class="modal-title" id="modalEncerrarAtendimento"> <i class="icofont-support fs-4"></i> Encerrar atendimento</h5>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <p id="p-modal-encerrar-atendimento"></p>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                                                            <button type="button" onclick="encerrarAtendimento()" class="btn btn-primary">Encerrar</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Chat: body -->
                            <ul id="chatBody" style="display: none;" class="chat-history list-unstyled mb-0 py-lg-5 py-md-4 py-3 flex-grow-1">
                                {{!-- <!-- Chat: left -->
                                <li class="mb-3 d-flex flex-row align-items-end">
                                    <div class="max-width-70">
                                        <div class="user-info mb-1">
                                            <span class="text-muted small">
                                            12:59, Hoje<br>Kevin:</span>
                                        </div>
                                        <div class="card border-0 p-3">
                                            <div class="message"> Olá, bom dia.</div>
                                        </div>
                                    </div>
                                </li>

                                <li class="mb-3 d-flex flex-row-reverse align-items-end">
                                    <div class="max-width-70 text-right">
                                        <div class="user-info mb-1">
                                            <span class="text-muted small">13:00, Hoje</span>
                                        </div>
                                        <div class="card border-0 p-3 bg-primary text-light">
                                            <div class="message">Bom dia, em que podemos ajudar?</div>
                                        </div>
                                    </div>
                                </li>

                                <li class="mb-3 d-flex flex-row align-items-end">
                                    <div class="max-width-70">
                                        <div class="user-info mb-1">
                                            <span class="text-muted small">
                                            12:59, Hoje<br>Kevin:</span>
                                        </div>
                                        <div class="card border-0 p-3">
                                            <div class="message"> Estou precisando de ajuda com minha fatura.</div>
                                        </div>
                                    </div>
                                </li>

                                <li class="mb-3 d-flex flex-row align-items-end">
                                    <div class="max-width-70">
                                        <div class="user-info mb-1">
                                            <span class="text-muted small">
                                            12:59, Hoje<br>Kevin:</span>
                                        </div>
                                        <div class="card border-0 p-3">
                                            <div class="message"> Estou precisando de ajuda com minha fatura.</div>
                                        </div>
                                    </div>
                                </li>

                                <li class="mb-3 d-flex flex-row align-items-end">
                                    <div class="max-width-70">
                                        <div class="user-info mb-1">
                                            <span class="text-muted small">
                                            12:59, Hoje<br>Kevin:</span>
                                        </div>
                                        <div class="card border-0 p-3">
                                            <div class="message"> Estou precisando de ajuda com minha fatura.</div>
                                        </div>
                                    </div>
                                </li>

                                <li class="mb-3 d-flex flex-row align-items-end">
                                    <div class="max-width-70">
                                        <div class="user-info mb-1">
                                            <span class="text-muted small">
                                            12:59, Hoje<br>Kevin:</span>
                                        </div>
                                        <div class="card border-0 p-3">
                                            <div class="message"> Estou precisando de ajuda com minha fatura.</div>
                                        </div>
                                    </div>
                                </li>

                                <li class="mb-3 d-flex flex-row align-items-end">
                                    <div class="max-width-70">
                                        <div class="user-info mb-1">
                                            <span class="text-muted small">
                                            12:59, Hoje<br>Kevin:</span>
                                        </div>
                                        <div class="card border-0 p-3">
                                            <div class="message"> Estou precisando de ajuda com minha fatura.</div>
                                        </div>
                                    </div>
                                </li>  --}}


                            </ul>
                            <!-- Chat: body -->
                            <ul id="chatBodyEmpty" class="chat-history list-unstyled mb-0 py-lg-5 py-md-4 py-3 flex-grow-1">
                                <div style="width: 100%; text-align: center;">
                                    <h3 class="text-muted">Nenhuma conversa selecionada</h3>
                                </div>
                            </ul>
                            <!-- Chat: Footer -->
                            <div id="chatFooterEmpty"><hr></div>
                            <div id="chatFooter" style="display:none;"class="chat-message">
                                 <!-- <form id="sendMessageToClient" action="">-->
                                  <!--  <form onsubmit="sendmsg(); return false;" > -->
                                    <div class="publisher bt-1 border-light">
                                        <i class="avatar avatar-xs icofont-brand-whatsapp" style="font-size: 30px; color: silver;"></i>
                                        <input id="textarea" class="form-control mb-1" placeholder="Escreva sua mensagem aqui...">
                                        <span class="publisher-btn file-group">
                                        <i class="fa fa-paperclip file-browser"></i>
                                        <input type="file">
                                        </span>
                                        <button id="send-msg" onclick="sendmsg()" class="btn btn-light btn-sm">
                                            <i class="icofont-paper-plane" style="font-size: 25px;"></i>
                                        </button>
                                    </div>
                               <!-- </form>-->
                            </div>
                        </div>
                    </div>
                    <!-- Modal Erro -->
                    <div class="modal fade frame-error" tabindex="-1" aria-labelledby="modalmessageerror" style="display: none;" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                            <div class="modal-error">
                                <img id="img-error" src="/images/alert.png" width="44" height="38" />
                                <span class="title-error">Oh rex!</span>
                                <p id="p-error">Ocorreu um erro ao processar a sua solicitação.</p>
                                <p id="p-error-message">Se o erro persistir, entre em contato com o administrador do sistema e informe o erro abaixo:</p>
                                <p id="messageToError"></p>
                                <div class="button-error">Fechar</div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- row end -->
            </div>
        </div>
    </div>
    <!-- Modal Members-->
    <div class="modal fade" id="addUser" tabindex="-1" aria-labelledby="addUserLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title  fw-bold" id="addUserLabel">Employee Invitation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="inviteby_email">
                        <div class="input-group mb-3">
                            <input type="email" class="form-control" placeholder="Email address" id="exampleInputEmail1" aria-describedby="exampleInputEmail1">
                            <button class="btn btn-dark" type="button" id="button-addon2">Sent</button>
                        </div>
                    </div>
                    <div class="members_list">
                        <h6 class="fw-bold ">Employee </h6>
                        <ul class="list-unstyled list-group list-group-custom list-group-flush mb-0">
                            <li class="list-group-item py-3 text-center text-md-start">
                                <div class="d-flex align-items-center flex-column flex-sm-column flex-md-column flex-lg-row">
                                    <div class="no-thumbnail mb-2 mb-md-0">
                                        <img class="avatar lg rounded-circle" src="/images/xs/avatar2.jpg" alt="">
                                    </div>
                                    <div class="flex-fill ms-3 text-truncate">
                                        <h6 class="mb-0  fw-bold">Rachel Carr(you)</h6>
                                        <span class="text-muted">rachel.carr@gmail.com</span>
                                    </div>
                                    <div class="members-action">
                                        <span class="members-role ">Admin</span>
                                        <div class="btn-group">
                                            <button type="button" class="btn bg-transparent dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="icofont-ui-settings  fs-6"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end">
                                                <li><a class="dropdown-item" href="#"><i class="icofont-ui-password fs-6 me-2"></i>ResetPassword</a></li>
                                                <li><a class="dropdown-item" href="#"><i class="icofont-chart-line fs-6 me-2"></i>ActivityReport</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li class="list-group-item py-3 text-center text-md-start">
                                <div class="d-flex align-items-center flex-column flex-sm-column flex-md-column flex-lg-row">
                                    <div class="no-thumbnail mb-2 mb-md-0">
                                        <img class="avatar lg rounded-circle" src="/images/xs/avatar3.jpg" alt="">
                                    </div>
                                    <div class="flex-fill ms-3 text-truncate">
                                        <h6 class="mb-0  fw-bold">Lucas Baker<a href="#" class="link-secondary ms-2">(Resend invitation)</a></h6>
                                        <span class="text-muted">lucas.baker@gmail.com</span>
                                    </div>
                                    <div class="members-action">
                                        <div class="btn-group">
                                            <button type="button" class="btn bg-transparent dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                            Members
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end">
                                                <li>
                                                    <a class="dropdown-item" href="#">
                                                    <i class="icofont-check-circled"></i>
                                                    <span>All operations permission</span>
                                                    </a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="#">
                                                    <i class="fs-6 p-2 me-1"></i>
                                                    <span>Only Invite & manage team</span>
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                        <div class="btn-group">
                                            <button type="button" class="btn bg-transparent dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="icofont-ui-settings  fs-6"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end">
                                                <li><a class="dropdown-item" href="#"><i class="icofont-delete-alt fs-6 me-2"></i>Delete Member</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li class="list-group-item py-3 text-center text-md-start">
                                <div class="d-flex align-items-center flex-column flex-sm-column flex-md-column flex-lg-row">
                                    <div class="no-thumbnail mb-2 mb-md-0">
                                        <img class="avatar lg rounded-circle" src="/images/xs/avatar8.jpg" alt="">
                                    </div>
                                    <div class="flex-fill ms-3 text-truncate">
                                        <h6 class="mb-0  fw-bold">Una Coleman</h6>
                                        <span class="text-muted">una.coleman@gmail.com</span>
                                    </div>
                                    <div class="members-action">
                                        <div class="btn-group">
                                            <button type="button" class="btn bg-transparent dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                            Members
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end">
                                                <li>
                                                    <a class="dropdown-item" href="#">
                                                    <i class="icofont-check-circled"></i>
                                                    <span>All operations permission</span>
                                                    </a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="#">
                                                    <i class="fs-6 p-2 me-1"></i>
                                                    <span>Only Invite & manage team</span>
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                        <div class="btn-group">
                                            <div class="btn-group">
                                                <button type="button" class="btn bg-transparent dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="icofont-ui-settings  fs-6"></i>
                                                </button>
                                                <ul class="dropdown-menu dropdown-menu-end">
                                                    <li><a class="dropdown-item" href="#"><i class="icofont-ui-password fs-6 me-2"></i>ResetPassword</a></li>
                                                    <li><a class="dropdown-item" href="#"><i class="icofont-chart-line fs-6 me-2"></i>ActivityReport</a></li>
                                                    <li><a class="dropdown-item" href="#"><i class="icofont-delete-alt fs-6 me-2"></i>Suspend member</a></li>
                                                    <li><a class="dropdown-item" href="#"><i class="icofont-not-allowed fs-6 me-2"></i>Delete Member</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
<script src="https://cdn.socket.io/4.5.0/socket.io.min.js" integrity="sha384-7EyYLQZgWBi67fBtVxw60/OWl1kjsfrPFcaU0pp0nAh+i8FD068QogUvg85Ewy1k" crossorigin="anonymous"></script>


<script>
    //var server = "https://pag.rexinternet.com.br:3000";
    //render message chat

        //Checar se a zenvia envia emoji
           // $('#textarea').emojioneArea({
           //     pickerPosition: "top"
           // });//

    const HOST = document.getElementById('my-host').innerText

    var server = HOST;
    var socket = io.connect(server);

    //render all messages that received
    socket.on("receivedMessage", (data) => {
        initialSocket(data)
    })

    function initialSocket(data){
      const phoneChat = document.getElementById("chat-client-phone").innerText
      const chatOpen = document.getElementById("chat-client-name").innerText
      var renderChatAutomatic = false

      if(phoneChat == data.fromClient){
        renderChatAutomatic = true
      }

      if(chatOpen != ''){
        viewerChat(data.atendimentoId, renderChatAutomatic)
      }

      if($('#em-espera-style').hasClass('active')){
        startListClients()
      } else if ($('#em-atendimento-style').hasClass('active')) {
        startListClientsEmAtendimento()
      }

      //Parte para adiconar no sininho se tem notificação
      var not = parseInt(document.getElementById('noti').innerText);
      not = not + 1;
      document.getElementById('noti').innerHTML = not;
      document.getElementById('noti2').innerHTML = not;
    }

    function renderMessageInChat(obj){
        const chatBody = document.getElementById('chatBody');

        const dateHourBr = new Date(obj.timeMsg)
        obj.timeMsg = dateHourBr.toLocaleString().replace(',', '').slice(0, -3).replace('/', '-').replace('/', '-')


        if(obj.isClient){
          messageClient(obj)
        }
    }

    var query = location.search.slice(1);
    var partes = query.split('&');
    var data = {};
    partes.forEach(function (parte) {
        var chaveValor = parte.split('=');
        var chave = chaveValor[0];
        var valor = chaveValor[1];
        data[chave] = valor;
    });

    function messageClient(obj){
       chatBody.insertAdjacentHTML("beforeend",`
            <li class="mb-3 d-flex flex-row align-items-end" id="messageOpen">
                <div class="max-width-70">
                    <div class="user-info mb-1">
                        <span class="text-muted small">
                            <br> ${obj.name}:
                        </span>
                    </div>
                    <div class="card border-0 p-3">
                        <div class="message"><p>${obj.body}</p> <p class="dateHourChat"> ${obj.timeMsg} </p></div>
                    </div>
                </div>
            </li>`
        )
    }

    function messageAtendente(obj){
       chatBody.insertAdjacentHTML("beforeend",`
          <li class="mb-3 d-flex flex-row justify-content-end" id="messageOpen">
              <div class="max-width-70">
                  <div class="user-info mb-1">
                      <span class="text-muted small">
                      <br>Robo Zenvia:</span>
                  </div>
                  <div class="card border-0 p-3">
                      <div class="message"><p>${obj.body}</p> <p class="dateHourChat"> ${obj.timeMsg} </p></div>
                  </div>
              </div>
        </li>`)
    }
            //headerClient chatBody chatFooter

    disableComponents()
    function disableComponents(){
      document.getElementById("headerClient").style.display = "none";
      document.getElementById("headerClientEmpty").style.display = "block";
      document.getElementById("chatBody").style.display = "none";
      document.getElementById("chatBodyEmpty").style.display = "block";
     // document.getElementById("buttonMoverAtendimentoDiv").style.display = "none";
      document.getElementById("chatFooter").style.display = "none";
      document.getElementById("chatFooterEmpty").style.display = "block";
      document.getElementById("chat-client-name").innerText = ''
      document.getElementById("chat-client-photo").src = ''
      document.getElementById("chat-client-type").innerText = ''
      document.getElementById("chat-client-phone").innerText = ''
      document.getElementById("chat-client-atendimento-id").innerText = ''
      document.getElementById("chat-received-zenvia-number").innerText = ''
    }

    startListClients()
    function startListClients(){
        $('.msg').fadeOut(600, function(){ $(this).remove();});
        const email = document.getElementById('my-mail').innerText
        fetch(HOST+'/wpp/last-message-client', {
            method: 'POST',
            headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
            },
            body: JSON.stringify({email: email}),
        })
        .then(res => res.json())
        .then(data => {
            if(data.error){
            throw new Error(data.error)
            }

            for(clients of data){
                const client = {
                    clientNumber: clients.from_wa_id,
                    clientName: clients.name,
                    timeMsg: clients.messageCreatedAt,
                    clientMsg: clients.body,
                    atendimentoId: clients.atendimentoId,
                    atendimentoStatus: clients.atendimentoStatus,
                    atendimentoUserId: clients.atendimentoUserId,
                    transferBy: clients.transfer_by
                }

                listContactsWaiting(client);
            }
        })
        .catch(err => {
            showModalError(err.message)
        })
    }

    function listContactsWaiting(obj){
        const dateHourBr = new Date(obj.timeMsg)
        obj.timeMsg = dateHourBr.toLocaleString().replace(',', '').slice(0, -3).replace('/', '-').replace('/', '-')

        $('#contact_area').prepend(
            `<div class="msg">
                <a onclick="viewerChat(${obj.atendimentoId})">
                <span id="infoMsg"></span>
                <li class="list-group-item px-md-4 py-3 py-md-4 n${obj.clientNumber}">
                    <div class="d-flex">
                        <img class="avatar lg rounded-circle img-thumbnail" style="border: 1px solid silver; text-align: center;" src="https://ui-avatars.com/api/?name=${obj.clientName}&background=random&color=ff0000&bold=true">
                        <div class="flex-fill ms-3 text-truncate">
                            <h6 class="d-flex justify-content-between mb-0"><span><b>${obj.clientName}</b></span> <small class="msg-time"><b>${obj.timeMsg}</b></small></h6>
                            <span class="text-muted"> <i class="icofont-swoosh-right   fs-5"></i></span>
                            ${obj.clientMsg}
                        </div>
                    </div>
                </li>
                </a>
            </div>`
        )
    }

    //startListClientsEmAtendimento()
    function startListClientsEmAtendimento(){
      $('.msg').fadeOut(600, function(){ $(this).remove();});
      const email = document.getElementById('my-mail').innerText
      fetch(HOST+'/wpp/last-message-client-in-service', {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({email: email}),
      })
      .then(res => res.json())
      .then(data => {
        if(data.error){
          throw new Error(data.error)
        }
        for(clients of data){

          const client = {
              clientNumber: clients.from_wa_id,
              clientName: clients.name,
              timeMsg: clients.messageCreatedAt,
              clientMsg: clients.body,
              atendimentoId: clients.atendimentoId,
              atendimentoStatus: clients.atendimentoStatus,
              atendimentoUserId: clients.atendimentoUserId
          }
          console.log('CLIENT TESTE ' + JSON.stringify(client))
          listContactsInService(client);
        }
      })
      .catch(err => {
        showModalError(err.message)
      })
    }

    onclickCloseChatBody()
    function onclickCloseChatBody(){
      document.getElementById("em-atendimento-style").setAttribute('onclick', `closeChatBodyEspera()`)
      document.getElementById("em-espera-style").setAttribute('onclick', `closeChatBodyAtendimento()`)
    }
    function closeChatBodyEspera(){
      document.getElementById('chatBody').innerHTML = ''
      disableComponents()
      startListClientsEmAtendimento()
    }
    function closeChatBodyAtendimento(){
      document.getElementById('chatBody').innerHTML = ''
      disableComponents()
      startListClients()
    }

    function listContactsInService(obj){
        const dateHourBr = new Date(obj.timeMsg)
        obj.timeMsg  = dateHourBr.toLocaleString().replace(',', '').slice(0, -3).replace('/', '-').replace('/', '-')

      $('#contact_area_atendimento').prepend(
          `<div class="msg">
            <a onclick="viewerChat(${obj.atendimentoId})" >
              <li class="list-group-item px-md-4 py-3 py-md-4 n${obj.clientNumber}">
                  <div class="d-flex">
                      <img class="avatar lg rounded-circle img-thumbnail" style="border: 1px solid silver; text-align: center;" src="https://ui-avatars.com/api/?name=${obj.clientName}&background=random&color=ff0000&bold=true">
                      <div class="flex-fill ms-3 text-truncate">
                          <h6 class="d-flex justify-content-between mb-0"><span>${obj.clientName}</span> <small class="msg-time">${obj.timeMsg}</small></h6>
                          <span class="text-muted"> <i class="icofont-swoosh-right   fs-5"></i></span>
                          ${obj.clientMsg}
                      </div>
                  </div>
              </li>
            </a>
          </div>`
      )
    }

    function renderMessagesInChat(arr){
      // Apaga as mensagens em aberto do chat
      document.getElementById('chatBody').innerHTML = ''

      var nameClient = ''
      var phoneClient = ''
      var statusClient = ''
      var atendimentoId = ''
      var roboNumber = ''

      for(item of arr){
        var timeMsg = item.created_at;

        const dateTime = timeMsg.split('T')
        const date = dateTime[0].split('-')
        const dateFinish = `${date[2]}-${date[1]}-${date[0]}`
        const time = dateTime[1].split('.')[0].split(':')
        // Ordem exemplo: 26-09-2022 10:40
        const timeFinish = `${dateFinish} ${time[0]}:${time[1]}`
        item.timeMsg = timeFinish

        if(item.perfil == 'CLIENTE'){
          messageClient(item)
          nameClient = item.name
          statusClient = item.status
          phoneClient = item.from_wa_id
          //atendimentoId = item.atendimento_id
          roboNumber= item.to_wa
        }

        if(item.perfil == 'ATENDENTE'){
          messageAtendente(item)
        }

      }

      var atendimentoId = document.getElementById("chat-client-atendimento-id").innerText
      //document.getElementById("buttonMoverAtendimentoDiv").style.display = "block";
      document.getElementById("chat-client-name").innerText = nameClient;
      document.getElementById("chat-client-photo").src = `https://ui-avatars.com/api/?name=${nameClient}&background=random&color=ff0000&bold=true`;
      document.getElementById("chat-client-type").innerText = statusClient
      document.getElementById("chat-client-phone").innerText = phoneClient;
      // document.getElementById("chat-client-atendimento-id").innerText = atendimentoId;
      document.getElementById("chat-received-zenvia-number").innerText = roboNumber;

      getStatusAtendimento(atendimentoId)
      .then(atendimento => {
        if(atendimento.error){
          throw new Error(data.error)
        }

        if (atendimento && atendimento.status == 'EM_ATENDIMENTO'){
          document.getElementById("buttonAtender").style.display = 'none'
          document.getElementById("chatFooterEmpty").style.display = 'none'
          document.getElementById("chatFooter").style.display = 'block'
        } else {
          document.getElementById("chatFooter").style.display = "none";
          document.getElementById("buttonAtender").style.display = "block";
          document.getElementById("buttonAtender").setAttribute('onclick', `butAtender(${atendimentoId})`)
          document.getElementById("chatFooterEmpty").style.display = "block";
        }

        enableComponents()

        // Scroll to message more recent after 500ms
        setTimeout(()=>{
          chatBody.scrollTop = chatBody.scrollHeight;
        }, 500)
      }).catch(err => {
        showModalError(err.message)
      })
      return
    }

    function getStatusAtendimento(atendimentoId){
      return fetch(HOST+'/service-status', {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({atendimentoId}),
      })
      .then(res => res.json())
      .then(data => {
        if(data.error){
          throw new Error(data.error)
        }
        return data
      }).catch(err => {
        showModalError(err.message)
      })
    }

    function atender(atendimentoId, userEmail){
      fetch(HOST+'/wpp/updatestatus', {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({atendimentoId, userEmail}),
      })
      .then(res => res.json())
      .then(data => {
        if(data.error){
          throw new Error(data.error)
        }
      }).catch(err => {
        showModalError(err.message)
      })
    }

//    function modalMoverAtendimento(clientNumber){
  //      let messageOpen = document.getElementById("chatBody").style.display
    //    if (messageOpen === 'block'){
            // $('#modalCloseMessage').modal('show')
      //      const clientName = document.getElementById("chat-client-name").innerText
        //    $('#spanInBodyModalCloseMessage').text("Mover o atendimento de "+clientName+" ("+clientNumber+") para a fila de " )
          //  document.getElementById("buttonMover").setAttribute('onclick', `atender(${clientNumber})`)
        //}
    //}

    function butAtender(atendimentoId){
      var userEmail = document.getElementById('my-mail').innerText
      var phoneChat = document.getElementById("chat-client-phone").innerText

      atender(atendimentoId, userEmail)

      $('#em-atendimento-style').addClass('active')
      $('#em-espera-style').removeClass('active')
      $('#em-atendimento').addClass('active')
      $('#em-atendimento').addClass('show')
      initialSocket({fromClient: phoneChat, atendimentoId})
    }

    function enableComponents(){
      document.getElementById("headerClient").style.display = "block";
      document.getElementById("headerClientEmpty").style.display = "none";
      document.getElementById("chatBody").style.display = "block";
      document.getElementById("chatBodyEmpty").style.display = "none";
    }

    function viewerChat(atendimentoId, renderAutomatic = true){
      //render msg of DB
      var userEmail = document.getElementById('my-mail').innerText
      if (typeof atendimentoId !== 'undefined') {
        // AJUSTAR ENVIO DE MENSAGEM APOS TRANSFERENCIA
          document.getElementById("chat-client-atendimento-id").innerText = atendimentoId
          //RENDER MESSAGES IN CHAT
          fetch(HOST+'/wpp/message-chat-client', {
            method: 'POST',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({atendimento_id: atendimentoId}),
          })
          .then(res => res.json())
          .then(data => {
            if(data.error){
              throw new Error(data.error)
            }

            //render msg chat
            if(renderAutomatic){
              renderMessagesInChat(data);
            }
          })
          .catch(err => {
            showModalError(err.message)
          })

      } else {
        disableComponents()
      }
    }

    function showModalError(message){
      $('#messageToError').text(message)
      $('.frame-error').modal('show');
    }

    function preparaEncerrarAtendimento(){
      const clientName = document.getElementById("chat-client-name").innerText
      $('#p-modal-encerrar-atendimento').text("Deseja encerrar o atendimento de " + clientName + "?")
    }

    function encerrarAtendimento(){
      const atendimentoId = document.getElementById("chat-client-atendimento-id").innerText
      fetch(HOST+'/finish-atendimento', {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ atendimentoId  }),
      })
      .then(res => res.json())
      .then(data => {
        if(data.error){
          throw new Error(data.error)
        }
      })
      .catch(err => {
        showModalError(err.message)
      })
      location.reload()
    }

    function sendmsg(){
      msg = document.getElementById('textarea').value;
      var chatBody = document.getElementById('chatBody');
      var chatPhone = document.getElementById("chat-client-phone").innerText;
      var chatAtendimentoId = document.getElementById("chat-client-atendimento-id").innerText;
      var roboNumber = document.getElementById("chat-received-zenvia-number").innerText;

      if(msg){
          sendMessageToClient(chatPhone, msg, chatAtendimentoId, roboNumber);
          messageAtendente({body: msg, timeMsg: ''})
      }

      chatBody.scrollTop = chatBody.scrollHeight;
      document.getElementById('textarea').value = '';
    }

    //Função da rota pra enviar para o cliente
    function sendMessageToClient(clientNumber, message, chatAtendimentoId, roboNumber){
      fetch(HOST+'/wpp/send-message',{
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({clientNumber, message, chatAtendimentoId, roboNumber}),
      })
      .then(res => res.json())
      .then(data => {
        if(data.error){
          throw new Error(data.error)
        }
      })
      .catch(err => {
        showModalError(err.message)
      })
    }

    const messages = document.getElementById('chatBody');

    function getMessages() {
        // Prior to getting your messages.
        shouldScroll = messages.scrollTop + messages.clientHeight === messages.scrollHeight;

        // After getting your messages.
        if (!shouldScroll) {
            scrollToBottom();
        }
    }

    function scrollToBottom() {
         const messages = document.getElementById('chatBody');
        //window.scrollTo(0, document.getElementById('chatBody').scrollHeight);
        messages.scrollTop = messages.scrollHeight;
    }

    scrollToBottom();

        //enviar msg ao apertar entter
    $(document).on('keydown', function(event) {
    if(event.keyCode === 13) {
        sendmsg();
    }
    });


    function search_conversation() {
        let input = document.getElementById('searchbar').value
        input=input.toLowerCase();
        let x = document.getElementsByClassName('msg');
        console.log(x)

            for (i = 0; i < x.length; i++) {
                if (!x[i].innerHTML.toLowerCase().includes(input)) {
                    x[i].style.display="none";
                }
                else {
                    x[i].style.display="list-item";
                }
            }
    }


</script>
